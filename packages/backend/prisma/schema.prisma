generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  CANCELLED
}

model User {
  id              String         @id @default(uuid())
  username        String         @unique
  password        String
  name            String
  role            String
  createdAt       DateTime       @default(now())
  currentRoomId   String?
  currentRoom     Room?          @relation(fields: [currentRoomId], references: [id])
  roomCheckedInAt DateTime?
  lastActivityAt  DateTime?
  entries         QueueEntry[]
  paymentsReceived QueueEntry[]  @relation("PaymentsReceived")
  auditLogs       AuditLog[]
  consultations   Consultation[]
  vaccinations    Vaccination[]
  queueFormPreference QueueFormPreference?
  @@index([currentRoomId])
  @@map("users")
}

model Room {
  id             String       @id @default(uuid())
  name           String       @unique
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  entries        QueueEntry[]
  checkedInUsers User[]

  @@map("rooms")
}

model Service {
  id        String   @id @default(uuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@map("services")
}

model QueueEntry {
  id                      String         @id @default(uuid())
  patientName             String
  tutorName               String
  serviceType             String
  priority                Int
  status                  String
  createdAt               DateTime       @default(now())
  calledAt                DateTime?
  completedAt             DateTime?
  assignedVetId           String?
  assignedVet             User?          @relation(fields: [assignedVetId], references: [id])
  roomId                  String?
  room                    Room?          @relation(fields: [roomId], references: [id])
  hasScheduledAppointment Boolean        @default(false)
  scheduledAt             DateTime?
  patientId               String?
  patient                 Patient?       @relation(fields: [patientId], references: [id])
  simplesVetId            String?
  paymentMethod           String?
  paymentStatus           PaymentStatus  @default(PENDING)
  paymentAmount           Decimal?       @db.Decimal(10, 2)
  paymentReceivedById     String?
  paymentReceivedBy       User?          @relation("PaymentsReceived", fields: [paymentReceivedById], references: [id])
  paymentReceivedAt       DateTime?
  paymentNotes            String?
  paymentHistory          Json?
  consultations           Consultation[]

  @@index([status])
  @@index([priority, createdAt])
  @@index([serviceType])
  @@index([assignedVetId])
  @@index([roomId])
  @@index([patientId])
  @@index([paymentStatus])
  @@index([paymentReceivedById])
  @@map("queue_entries")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  action     String
  entityType String
  entityId   String?
  metadata   Json?
  timestamp  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

model Tutor {
  id        String    @id @default(uuid())
  name      String
  phone     String?
  email     String?
  cpfCnpj   String?
  address   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  patients  Patient[]

  @@index([name])
  @@index([phone])
  @@index([cpfCnpj])
  @@map("tutors")
}

model Patient {
  id               String         @id @default(uuid())
  name             String
  species          String?
  breed            String?
  birthDate        DateTime?
  gender           String?
  microchip        String?
  color            String?
  currentWeight    Float?
  allergies        String?
  ongoingMedications String?
  temperament      String?
  neutered         Boolean?       @default(false)
  photoUrl         String?
  tutorId          String?
  tutor            Tutor?         @relation(fields: [tutorId], references: [id], onDelete: SetNull)
  tutorName        String
  tutorPhone       String?
  tutorEmail       String?
  tutorCpfCnpj     String?
  tutorAddress     String?
  notes            String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  queueEntries     QueueEntry[]
  consultations    Consultation[]
  vaccinations     Vaccination[]

  @@index([name])
  @@index([tutorId])
  @@index([tutorName])
  @@index([tutorPhone])
  @@index([microchip])
  @@map("patients")
}

model Consultation {
  id           String      @id @default(uuid())
  patientId    String
  patient      Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  queueEntryId String?
  queueEntry   QueueEntry? @relation(fields: [queueEntryId], references: [id], onDelete: SetNull)
  vetId        String?
  vet          User?       @relation(fields: [vetId], references: [id], onDelete: SetNull)
  diagnosis    String?
  treatment    String?
  prescription String?
  weightInKg   Float?
  notes        String?
  date         DateTime    @default(now())
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([patientId])
  @@index([queueEntryId])
  @@index([date])
  @@index([vetId])
  @@map("consultations")
}

model Vaccination {
  id           String    @id @default(uuid())
  patientId    String
  patient      Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  vaccineName  String
  appliedDate  DateTime  @default(now())
  batchNumber  String?
  vetId        String?
  vet          User?     @relation(fields: [vetId], references: [id], onDelete: SetNull)
  nextDoseDate DateTime?
  notes        String?
  createdAt    DateTime  @default(now())

  @@index([patientId])
  @@index([appliedDate])
  @@index([nextDoseDate])
  @@index([vetId])
  @@map("vaccinations")
}

model RoleModulePermission {
  id        String   @id @default(uuid())
  role      String
  module    String
  createdAt DateTime @default(now())

  @@unique([role, module])
  @@index([role])
  @@map("role_module_permissions")
}

model QueueFormPreference {
  userId            String      @id
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastTutorId       String?
  lastTutorName     String?
  lastPatientId     String?
  lastPatientName   String?
  lastServiceType   String?
  lastPriority      Int?
  lastAssignedVetId String?
  lastHasAppointment Boolean?  @default(false)
  lastSimplesVetId  String?
  updatedAt         DateTime    @updatedAt
  createdAt         DateTime    @default(now())

  @@map("queue_form_preferences")
}
